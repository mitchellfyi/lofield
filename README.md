# Lofield FM

**Background noise for people just trying to make it through the day.**

Lofield FM is a fictional local radio station for the made-up town of Lofield—a community of remote workers, freelancers, and digital nomads all trying to stay sane between video calls. Everything you hear on Lofield FM is generated by AI: the lofi music, the presenters, the station idents, even the local weather reports for a town that doesn't exist.

## What is Lofield FM?

Lofield FM is an experimental AI-powered radio station that combines:

- **AI-generated lofi music** tailored to the time of day and mood
- **AI presenters** with distinct personalities who chat between tracks
- **Listener requests** moderated and upvoted by the community
- **Seasonal and holiday programming** that adapts to the calendar
- **A consistent fictional world** with running jokes and local landmarks

The station runs 24/7 with a rotating schedule of shows, each with its own vibe and talk-to-music ratio. Presenters work in duos and hand over to each other with brief five-minute crossover segments.

## Core Concept

Think of Lofield FM as your co-working companion. It's not here to motivate you or solve your problems—it's just here, playing chill beats and occasionally acknowledging that yes, your Wi-Fi probably *is* worse than everyone else's, and yes, that meeting could have been an email.

The humour is dry, self-deprecating, and occasionally dark (but never cruel). The music is always lofi. The town of Lofield is always stuck in roadworks. And the presenters are always there, like that colleague you don't really talk to but nod at in the break room.

## How It Works

1. **Music Generation**: Listener requests are normalized by an LLM and fed to a text-to-music AI model that generates lofi tracks on demand
2. **Presenter Commentary**: AI DJs introduce tracks, read out requests, and riff on life in Lofield using text-to-speech
3. **Request System**: Listeners submit song ideas that get moderated, classified, and upvoted by the community
4. **Playout Engine**: A scheduling system queues tracks and presenter segments, maintaining the right talk/music balance for each show
5. **Archiving**: Past shows are stored and available through a "rewind" feature

## Project Structure

```
lofield/
├── README.md                 # This file
├── BACKEND.md                # Backend services documentation
├── web/                      # Next.js 16 frontend & API
│   ├── app/                  # Next.js app directory
│   │   ├── api/              # API routes (requests, now-playing, queue, etc.)
│   │   └── ...               # Pages and components
│   ├── lib/                  # Utilities and database client
│   ├── prisma/               # Database schema and migrations
│   └── ...
├── services/                 # Backend services
│   └── scheduler/            # Content generation scheduler
├── config/                   # Station configuration files
│   ├── station.json         # Global station settings
│   ├── presenters.json      # All presenter definitions
│   ├── tags.json            # Topic and holiday tags
│   └── shows/               # Individual show configurations (8 files)
├── schemas/                  # Configuration schema documentation
├── scripts/                  # Validation and utility scripts
└── docs/
    ├── architecture.md       # Technical pipeline overview
    ├── contributing.md       # How to contribute
    ├── schedule.md           # 24-hour programming schedule
    ├── style_guide.md        # Voice, tone, and content guidelines
    └── town_bible.md         # Lofield town lore and landmarks
```

## Tech Stack

### Backend
- **Framework**: Next.js 16 API Routes (TypeScript)
- **Database**: PostgreSQL with Prisma ORM
- **Real-time**: Server-Sent Events for live updates
- **Scheduler**: Node.js service for content generation
- **Streaming**: Icecast (or Node-based alternative)

See [BACKEND.md](BACKEND.md) for comprehensive backend documentation.

## Getting Started

The repo ships with a `Makefile` that wraps every Docker Compose command. Unless you're debugging a single service, follow the automated flow below.

### 1. Install prerequisites
- [Docker Desktop 4.7+](https://docs.docker.com/get-docker/) (ships with Compose v2)
- GNU Make 3.8+
- Git
- API keys: OpenAI + Replicate (optional: ElevenLabs, Stability)

### 2. Bootstrap environment variables

```bash
make setup
```

`make setup` copies `.env.docker → .env` (if needed) and syncs the root `.env` into `web/.env`, `web/.env.local`, `services/scheduler/.env`, and `services/playout/.env`. Edit `.env` once and fill in:
- `POSTGRES_PASSWORD`
- `ICECAST_SOURCE_PASSWORD`, `ICECAST_ADMIN_PASSWORD`, `ICECAST_RELAY_PASSWORD`
- `OPENAI_API_KEY`
- `REPLICATE_API_TOKEN`

Whenever you change `.env`, run `make env-sync` to re-copy it everywhere.

### 3. Launch all services

```bash
make dev
```

This builds (if necessary) and runs PostgreSQL, Icecast, Next.js, the scheduler, and the playout engine. Use `CTRL+C` to stop, or `make stop` from another terminal. For live code reload, use:

```bash
make dev-hot
```

### 4. Apply migrations & seed data

```bash
make migrate
make seed
```

### 5. Visit the stack

| Service | URL | Notes |
| --- | --- | --- |
| Web UI + API | http://localhost:3000 | Next.js app + API routes |
| Health check | http://localhost:3000/api/health | Basic uptime probe |
| SSE events | http://localhost:3000/api/events | Stream of request + now playing events |
| Live stream | http://localhost:8000/lofield | MP3 mount served by Icecast |
| Icecast admin | http://localhost:8000/admin/ | User: `admin`, Pass: `ICECAST_ADMIN_PASSWORD` |

### Helpful commands

```bash
make logs        # Tail all container logs
make status      # Show container status/ports
make stop        # Stop containers, keep volumes/data
make clean       # Stop and remove volumes (wipes DB/audio)
make restart     # Restart all running services
make env-sync    # Re-copy root .env into each service directory
```

See [DOCKER.md](DOCKER.md) for production profiles, overrides, and CI/CD usage.

### Manual setup (advanced)

You can still run services outside Docker for deep debugging, but keep `.env` as the single source of truth:

1. Run `make env-sync` whenever you change `.env` so `web/.env.local` and `services/*/.env` stay aligned.
2. Use Docker only for stateful dependencies:
   ```bash
   docker compose up -d postgres icecast
   ```
3. Start the frontend manually:
   ```bash
   cd web
   npm install
   npm run dev
   ```
4. Start backend services the same way (inside `services/scheduler` or `services/playout`) if you genuinely need local Node processes.

Direct Node workflows are not officially supported for onboarding; expect to wire up Prisma + caching yourself. For everything else, lean on the Makefile targets above.

### Local tooling & quality checks

The repo root now owns shared automation so you can run every safety check without cd-ing into subprojects:

- `npm install` (run once in the repo root) installs Husky + shared dev tooling
- `make lint`, `make format`, `make format-check`, `make typecheck`, `make test` proxy straight to the corresponding npm scripts
- `npm run ci:quick` / `make quick-ci` runs lint → format check → typecheck → Jest (in-band) → `next build` → `python3 scripts/validate_config.py`
- `npm run config:validate` / `make validate-config` wraps the JSON validator

> **Pre-push hook**  
> Husky now blocks pushes unless `npm run ci:quick` succeeds. After pulling this change (or cloning fresh), run `npm install` at the repo root once so `.husky/pre-push` is installed locally.

### Configuration

**Configuration**: The station is defined by JSON configuration files in the `config/` directory. See [config/README.md](config/README.md) for an overview of the configuration system.

**Technical details**: For information about how the AI pipeline works, see [docs/architecture.md](docs/architecture.md).

**Voice and tone**: To understand the station's voice and humour, read [docs/style_guide.md](docs/style_guide.md).

To learn about the fictional world of Lofield, check out [docs/town_bible.md](docs/town_bible.md).

## Contributing

We welcome contributions! Whether you want to propose a new show, improve the AI prompts, or fix bugs, see [docs/contributing.md](docs/contributing.md) for guidelines.

## License

This project is experimental and educational. All AI-generated content is created on-the-fly and not stored permanently (except in archives).

---

*Lofield FM: Now playing on a frequency that probably doesn't exist.*
